(function(t){"use strict";var e={},r=(e.version="0.5.0a01",function(){var t=Object.prototype.toString;return function(e){return t.call(e)}}()),n=Array.isArray||function(t){return"[object Array]"===r(t)},o=function(){var t=Array.prototype.slice;return function(e,r){return t.call(e,r)}}(),i=e.invoke=function(t,e,r){if("function"!=typeof t)throw new TypeError("argument 0 must be a valid function");var e=e||[],r=r||null;switch(e.length){case 0:return t.call(r);case 1:return t.call(r,e[0]);case 2:return t.call(r,e[0],e[1]);case 3:return t.call(r,e[0],e[1],e[2]);default:return t.apply(r,e)}},u=e.class=function(){var t=2==arguments.length?arguments[0]:null,e=t?t.prototype:{},r=function(e){return"function"==typeof e?e(t):e||{}}(arguments[arguments.length-1]),n=r.hasOwnProperty("constructor")?function(){var t=r.constructor.value||r.constructor;return delete r.constructor,t}():function(){};return Object.defineProperties(n,{prototype:{value:Object.create(e,r)},constructor:{value:n}}),n.create=function(){function t(){return i(n,e,this)}var e=arguments;return t.prototype=n.prototype,new t},n.extend=function(t){return u(n,t)},n},s=(e.singleton=function(){var t,e,r;return t=i(Klass,arguments,null),e=function(){return r?r:(r=this,t.call(this),void 0)},e.prototype=t.prototype,e},e.errors={StopIterationError:u(Error,{constructor:{value:function(t){this.name="StopIteration",this.message=t||""}}})}),a=e.EventEmitter=u(function(){function t(t,e){this.prefix=t+":",this.emitter=e}return{_eventEmitter:{value:!0},emit:{value:function(t){var e,r,n,u=this._events||Object.defineProperty(this,"_events",{value:{}})._events,s=this._pipes||Object.defineProperty(this,"_pipes",{value:[]})._pipes,c=u[t],l=arguments.length>1?o(arguments,1):[];if("string"!=typeof t)return this.emit("error",new TypeError("invalid argument 0"));if("error"==t&&!c)throw arguments[1]instanceof Error?arguments[1]:Error(arguments[1]);if(c)if("function"==typeof c)i(c,l);else for(e=[].concat(c),r=0,n=e.length;n>r;r++)i(e[r],l);for(r=0,n=s.length;n>r;r++)i(a.prototype.emit,[s[r].prefix+t].concat(l),s[r].emitter);return this}},on:{value:function(t,e){var r=this._events||Object.defineProperty(this,"_events",{value:{}})._events,n=r[t];return e&&"function"==typeof e?(n?"function"==typeof n?r[t]=[r[t],e]:n.push(e):r[t]=e,this):this.emit("error",new TypeError("invalid argument 1"))}},once:{value:function(t,e){var r,n=this;return e&&"function"==typeof e?(r=function(){i(e,arguments,null),n.off(t,r)},this.on(t,r)):this.emit("error",new TypeError("missing/bad arguments[1]"))}},off:{value:function(t,e){var r,n=this._events||Object.defineProperty(this,"_events",{value:{}})._events,o=n[t];if(!t||"string"!=typeof t)return this.emit("error",new TypeError("invalid argument 0"));if("function"==typeof e&&o)if(o==e)delete n[t];else{for(;r=o.indexOf(e),!!~r;)n[t].splice(r,1);n[t].length||delete n[t]}return"*"==e&&delete n[t],this}},listeners:{value:function(t){var e=this._events||Object.defineProperty(this,"_events",{value:{}})._events,r=e[t];return r?"function"==typeof r?[r]:r:[]}},pipe:{value:function(e,r){var n=this._pipes||Object.defineProperty(this,"_pipes",{value:[]})._pipes;return e&&"string"==typeof e||this.emit("error",new TypeError("invalid argument 0")),r&&r instanceof a||this.emit("error",new TypeError("invalid argument 1")),n.push(new t(e,r)),this}},unpipe:{value:function(){var t=this._pipes||Object.defineProperty(this,"_pipes",{value:[]})._pipes;return t.length,this}},toString:{value:function(){return"[object EventEmitter]"}}}}),c=(e.Promise=function(){var t=u(a,{_promise:{value:!0},then:{value:function(t,e,r){var n=this._state||Object.defineProperty(this,"_state",{configurable:!0,value:-1})._state,o=this._yield||null;return 1==n&&"function"==typeof t&&i(t,o,null),0==n&&"function"==typeof e&&i(e,o,null),-1==n&&("function"==typeof t&&this.once("resolve",t),"function"==typeof e&&this.once("reject",e),"function"==typeof r&&this.on("progress",r)),this}},resolve:{value:function(){var t=arguments.length?o(arguments):[];if(1!==this._state)try{Object.defineProperty(this,"_state",{configurable:!1,value:1}),Object.defineProperty(this,"_yield",{configurable:!1,value:t})}catch(e){return this.emit("error",e)}return i(a.prototype.emit,["resolve"].concat(t),this)}},reject:{value:function(){var t=arguments.length?o(arguments):[];if(0!==this._state)try{Object.defineProperty(this,"_state",{configurable:!1,value:0}),Object.defineProperty(this,"_yield",{configurable:!1,value:t})}catch(e){return this.emit("error",e)}return i(a.prototype.emit,["reject"].concat(t),this)}},progress:{value:function(){var t=arguments.length?o(arguments):[];if(-1!==this._state)try{Object.defineProperty(this,"_state",{configurable:!0,value:-1})}catch(e){return this.emit("error",e)}return-1==this._state?i(a.prototype.emit,["progress"].concat(t),this):void 0}},status:{get:function(){return this._state||-1}},yield:{get:function(){return n(this._yield)?[].concat(this._yield):null}},valueOf:{value:function(){return this.status}},toString:{value:function(){return"[object Promise]"}}}),e=u(t,{constructor:{value:function(){var e,r,n,i=this;if(Object.defineProperties(this,{_promises:{value:[]},_yield:{configurable:!0,value:[]},_state:{configurable:!0,value:-1}}),!arguments.length)return this.resolve(null);for(e=1==arguments.length?[arguments[0]]:o(arguments),r=0,n=e.length;n>r;r++)e[r]instanceof t?function(t,e){i._promises[e]=t,t.then(function(r){i._yield[e]=r,i.progress(t,r)},function(r){i._yield[e]=r,i.reject(t)})}(e[r],r):setTimeout(function(){i.emit("error",new TypeError("invalid promise"))},0)}},progress:{value:function(e,r){var n,o,u=this._promises||[],s=0;for(n=0,o=u.length;o>n;n++)switch(u[n].status){case-1:s++;break;case 0:return this.reject(this._yield)}return s?i(a.prototype.emit,["progress"].concat([e,r]),this):i(t.prototype.resolve,this._yield,this),this}}}),r=u(t,{constructor:{value:function(){}}});return t.group=function(){var t=arguments,r=function(){return i(e,t,this)};return r.prototype=e.prototype,new r},t.sequence=function(){var t=arguments,e=function(){return i(r,t,this)};return e.prototype=r.prototype,new e},t}(),e.Iterator=u(a,{constructor:{value:function(t,e,r){if(!t)return this.emit("error",new TypeError("missing arguments 0 when constructing new Iterator object"));var n,o,i,u=this,r="function"==typeof arguments[arguments.length-1]?arguments[arguments.length-1]:null,e="function"!=typeof arguments[1]?!!arguments[1]:!1;try{n=Object.keys(t)}catch(s){n=[],setTimeout(function(){u.emit("error",s)},0)}for(Object.defineProperties(this,{_pointer:{writable:!0,value:-1},_current:{writable:!0,value:null},_range:{value:[]}}),o=0,i=n.length;i>o;o++)this._range.length+=1,this._range[o]=e?[n[o]]:[n[o],t[n[o]]];r&&(this.onstopiteration=r)}},onstopiteration:{writable:!0,value:null},next:{value:function(){var t,e=this._pointer+1;return e>=this._range.length?function(t){var e=new s.StopIterationError;return"function"==typeof t.onstopiteration?t.onstopiteration(e):t.emit("error",e)}(this):(this._pointer=e,t=this._current=this._range[e])}},"enum":{get:function(){for(var t,e=this._range||[],r={},n=new c(e,function(){});t=n.next();)r[t[1][0]]=t[1][1];return r}},length:{get:function(){return(this._range||[]).length}},valueOf:{value:function(){return this.length}},toString:{value:function(){return"[object Iterator]"}}})),l=(e.Router=u(a,{constructor:{value:function(t,e){var e="function"==typeof arguments[arguments.length-1]?arguments[arguments.length-1]:function(){return!1},t=arguments[0]&&arguments[0].constructor==Object?arguments[0]:null;Object.defineProperties(this,{_routes:{value:{}},_dispatcher:{writable:!0,value:e}}),t&&this.when(t)}},onstopiteration:{writable:!0,value:null},dispatch:{value:function(){var t=this,e=o(arguments),r=new c(this._routes),n=function(r){var n,o,s;if(n=r[1],"function"==typeof n)return i(n,[u].concat(e));for(o=0,s=n.length-1;s>o;o++)i(n[o],[function(){setTimeout(function(){t.emit("error","next() invoked on a non-last route handler (manage your routes handlers carefully)")},0)}].concat(e));return i(n[s],[u].concat(e))},u=function(){var o,a;try{o=r.next(),a="*"===o[0]?!0:i(t._dispatcher,[o[0]].concat(e),null)}catch(c){return c instanceof s.StopIterationError&&"function"==typeof t.onstopiteration?i(t.onstopiteration,[c].concat(e),t):t.emit("error",c)}return a?n(o):u()};return u()}},when:{value:function(t,e){var r,n,o;if(1==arguments.length){for(r=Object.keys(t),n=0,o=r.length;o>n;n++)this.when(r[n],t[r[n]]);return this}return"function"!=typeof e&&this.emit("error",new TypeError("argument 1 is expected to be a function")),void 0==this._routes[t]?this._routes[t]=e:"function"==typeof this._routes[t]?this._routes[t]=[this._routes[t],e]:this._routes[t].push(e),this}},length:{get:function(){return Object.keys(this._routes||{}).length}},valueOf:{value:function(){return this.length}},toString:{value:function(){return"[object Router]"}}}),e.Model=u(a,{_model:{value:!0},constructor:{value:function(){arguments.length&&i(l.prototype.set,arguments,this)}},set:{value:function(t,e){var r,o,u=this._data||Object.defineProperty(this,"_data",{value:{}})._data;return 1==arguments.length?"string"==typeof t?this._fromJSON(t):this._fromHash(t):"string"!=typeof t?this.emit("error",new TypeError("invalid argument 0")):e&&e.constructor===Object?this._fromHash(e,t):e&&e.constructor===Object?this._fromHash(e,t):(r=(this._hooks||{})[t]||null,o=u[t],"function"==typeof e&&(e=i(e,[this])),"function"==typeof r&&(e=i(r,[e],this)),n(e)&&(e=[].concat[e]),u.hasOwnProperty(t)||(this.emit("add>"+t,e),this.emit("add",t,e)),u[t]=e,this.emit("change>"+t,e,o),this.emit("change",t,e,o),this)}},_fromHash:{value:function(t,e){for(var r,n=this,o=new c(t,function(){}),e=e?e+".":"";r=o.next();)(function(){n.set(e+r[0],r[1])})();return this}},_fromJSON:{value:function(t){var e;try{e=JSON.parse(t)}catch(r){return this.emit("error",r)}return this._fromHash(e)}},_hooks:{configurable:!0,value:null},hook:{value:function(t,e){var r;return 1==arguments.length&&t&&t.constructor==Object?function(t,e){for(var r,n=new c(t,function(){});r=n.next();)return e.hook(r[0],r[1])}(t,this):(r=this._hooks||Object.defineProperty(this,"_hooks",{value:{}})._hooks,"string"!=typeof t?this.emit("error",new TypeError("invalid argument 0")):1==arguments.length?r[t]:"function"!=typeof e?this.emit("error",new TypeError("invalid argument 1")):(r[t]=e,this))}},get:{value:function(t){var e,r,n,i=this,u=this._data||{},s=[];if(!arguments.length)return null;if(1==arguments.length){if("string"==typeof t)return u[t];e=[t]}for(arguments.length>1&&(e=o(arguments)),r=0,n=e.length;n>r;r++)"string"!=typeof e[r]&&("number"==typeof e[r]?e[r]=""+e[r]:(e[r]="",setTimeout(function(){i.emit("error",new TypeError("invalid key"))},0))),s.push(this.get(e[r]));return s}},keys:{get:function(){var t=this._data.hash||{},e=Object.keys(t);return e}},length:{get:function(){return this.keys.length}},valueOf:{value:function(){return this.length}},toString:{value:function(){return"[object Model]"}}})),f=e.Collection=u(a,function(){return{_collection:{value:!0},constructor:{value:function(){arguments.length&&i(f.prototype.add,arguments,this)}},_Model:{writable:!0,value:l},Model:{set:function(t){new t instanceof l||this.emit("error",new TypeError("invalid model")),this._Model=t},get:function(){return this._Model}},add:{value:function(t){var e,r,i,u=this,s=this._models||Object.defineProperty(this,"_models",{value:[]})._models;if(!arguments.length)return this;for(arguments.length>1?e=o(arguments):1==arguments.length&&(e=n(t)?t:[t]),r=0,i=e.length;i>r;r++)e[r]instanceof l?function(t){~s.indexOf(t)||(t.pipe("models",u),s.push(t))}(e[r]):e[r]instanceof f&&n(e[r]._models)?this.add(e[r]._models):e[r]&&e[r].constructor===Object?this._fromHash(e[r]):"string"==typeof e[r]?this._fromJSON(e[r]):setTimeout(function(){u.emit("error",new TypeError("invalid object in models/collections list"))},0);return this}},_fromHash:{value:function(t){var e=this,r=this._Model,n=new r;return n.on("error",function(t){e.add(t)}),n.set(t),this.add(n)}},_fromJSON:{value:function(t){var e;try{e=JSON.parse(t)}catch(r){return this.add(r)}return this.add(e)}},remove:{value:function(){for(var t,e=this._models||Object.defineProperty(this,"_models",{value:[]})._models,r=i(f.prototype.find,arguments,this),n=[];r.length;)t=e.indexOf(r.shift()),!~t||(n=e.splice(t,1));return n}},find:{value:function(){var t,e,r,i,u=this,s=this._models||[],a=new c(s,function(){}),l=[],f=[],h=[];if(!arguments.length)return this.emit("error",new TypeError("empty search query"));if("*"===arguments[0])return this.models;for(f=arguments.length>1?o(arguments):n(arguments[0])?arguments[0]:[arguments[0]],r=0,i=f.length;i>r;r++)(function(t){var e,r=new c(t,function(){});for(r.on("error",function(t){u.emit("error",t)});e=r.next();)h.push(e)})(f[r]);for(;t=a.next();)e=function(t){var e,r,n,o,i;for(e=0,r=h.length;r>e;e++)if(n=h[e][0],o=h[e][1],i="function"==typeof o?o(t.get(n)):t.get(n)==o,!i)return!1;return!0}(t[1]),e&&l.push(t[1]);return l}},subset:{value:function(){var t=i(f.prototype.find,arguments,this);return new f(t)}},sort:{value:function(){return n(this._models)&&i(Array.prototype.sort,arguments,this._models),this}},set:{value:function(){for(var t,e=this._models||[],r=new c(e,function(){});t=r.next();)i(l.prototype.set,arguments,t[1]);return this}},get:{value:function(){for(var t,e=this._models||[],r=[],n=new c(e,function(){});t=n.next();)r.push(i(l.prototype.get,arguments,t[1]));return r}},models:{get:function(){var t=this._models||[];return[].concat(t)}},length:{get:function(){var t=this._models||[];return t.length}},valueOf:{value:function(){return this.length}},toString:{value:function(){return"[object Collection]"}}}});t.sleipnir=e})(window);